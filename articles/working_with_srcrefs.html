<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with srcrefs • covtracer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with srcrefs">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">covtracer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/combining_srcref_data.html">Combining srcref Data</a></li>
    <li><a class="dropdown-item" href="../articles/plotting_test_paths.html">Plotting Test Paths</a></li>
    <li><a class="dropdown-item" href="../articles/working_with_srcrefs.html">Working with srcrefs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/genentech/covtracer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Working with srcrefs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/genentech/covtracer/blob/main/vignettes/working_with_srcrefs.Rmd" class="external-link"><code>vignettes/working_with_srcrefs.Rmd</code></a></small>
      <div class="d-none name"><code>working_with_srcrefs.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/genentech/covtracer" class="external-link">covtracer</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="what-are-srcref-objects">What are <code>srcref</code> objects?<a class="anchor" aria-label="anchor" href="#what-are-srcref-objects"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">examplepkg_ns</span><span class="op">$</span><span class="va">hypotenuse</span><span class="op">)</span></span>
<span><span class="co">#&gt; function(a, b) {</span></span>
<span><span class="co">#&gt;   return(sqrt(a^2 + b^2))</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55950b6062f0&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:examplepkg&gt;</span></span></code></pre></div>
<p><code>srcref</code>s are a base R data type that is used frequently
for working with package code. When you install a package using the
<code>--with-keep.source</code> flag, data about the package’s source
code representation is bound to the objects that the namespace attaches
or loads. In short, <code>srcref</code>s are simple data structures
which store the file path of the source code and information about where
to find the relevant bits in that file including line and character
columns of the start and end of the source code.</p>
<blockquote>
<p>For extensive details, refer to <code><a href="https://rdrr.io/r/utils/sourceutils.html" class="external-link">?getSrcref</a></code> and
<code><a href="https://rdrr.io/r/base/srcfile.html" class="external-link">?srcref</a></code>.</p>
</blockquote>
<p>Lets see it in action:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sourceutils.html" class="external-link">getSrcref</a></span><span class="op">(</span><span class="fu">covtracer</span><span class="fu">::</span><span class="va"><a href="../reference/test_trace_df.html">test_trace_df</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get line and column ranges (for details see ?srcref)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/sourceutils.html" class="external-link">getSrcref</a></span><span class="op">(</span><span class="fu">covtracer</span><span class="fu">::</span><span class="va"><a href="../reference/test_trace_df.html">test_trace_df</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; numeric(0)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sourceutils.html" class="external-link">getSrcFilename</a></span><span class="op">(</span><span class="fu">covtracer</span><span class="fu">::</span><span class="va"><a href="../reference/test_trace_df.html">test_trace_df</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="extracting-relevant-traceability-srcrefs">Extracting relevant traceability <code>srcref</code>s<a class="anchor" aria-label="anchor" href="#extracting-relevant-traceability-srcrefs"></a>
</h2>
<p>Instead of working with these objects directly, there are a few
helper functions for making these objects easier to extract. For tracing
coverage paths, there are three important classes of
<code>srcref</code>s:</p>
<ol style="list-style-type: decimal">
<li>Package namespace object <code>srcref</code>s</li>
<li>Test code <code>srcref</code>s</li>
<li>Coverage trace <code>srcref</code>s</li>
</ol>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>Before we begin, we’ll get a package test coverage object and store
the package namespace. We take extra precaution to use a temporary
library for the sake of example, but this is only necessary when we want
to avoid installing the package into our working library.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://withr.r-lib.org" class="external-link">withr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://covr.r-lib.org" class="external-link">covr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_temp_libpaths.html" class="external-link">with_temp_libpaths</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>keep.source <span class="op">=</span> <span class="cn">TRUE</span>, keep.source.pkg <span class="op">=</span> <span class="cn">TRUE</span>, covr.record_tests <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">examplepkg_source_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examplepkg"</span>, package <span class="op">=</span> <span class="st">"covtracer"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span></span>
<span>    <span class="va">examplepkg_source_path</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"source"</span>,</span>
<span>    repos <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    INSTALL_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"--with-keep.source"</span>, <span class="st">"--install-tests"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">examplepkg_cov</span> <span class="op">&lt;-</span> <span class="fu">covr</span><span class="fu">::</span><span class="fu"><a href="http://covr.r-lib.org/reference/package_coverage.html" class="external-link">package_coverage</a></span><span class="op">(</span><span class="va">examplepkg_source_path</span><span class="op">)</span></span>
<span>  <span class="va">examplepkg_ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-reflect.html" class="external-link">getNamespace</a></span><span class="op">(</span><span class="st">"examplepkg"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="functions-for-extracting-srcrefs">Functions for extracting <code>srcref</code>s<a class="anchor" aria-label="anchor" href="#functions-for-extracting-srcrefs"></a>
</h3>
<p>There are a few functions for teasing out this information
succinctly. These include <code>pkg</code>, <code>trace</code>, and
<code>test</code> flavors for <code>*_srcefs</code> and
<code>*_srcrefs_df</code> families of functions (eg,
<code><a href="../reference/pkg_srcrefs_df.html">pkg_srcrefs_df()</a></code>). <code>*_srcrefs()</code> functions
return a more primitive <code>list</code> objects. Because these can be
a bit cumbersome to read through, <code>*_srcrefs_df()</code>
alternatives are provided for improved introspection and
readability.</p>
<blockquote>
<p><code>data.frame</code> results contain a <code>srcref</code> column,
where each element is a <code>srcref</code> object. Even though this
appears as a succinct text, it contains all the <code>srcref</code>
data.</p>
</blockquote>
<div class="section level4">
<h4 id="extracting-package-namespace-object-srcrefs">Extracting package namespace object <code>srcref</code>s<a class="anchor" aria-label="anchor" href="#extracting-package-namespace-object-srcrefs"></a>
</h4>
<p>Getting a <code>list</code> of <code>srcref</code>s</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_srcrefs.html">pkg_srcrefs</a></span><span class="op">(</span><span class="va">examplepkg_ns</span><span class="op">)</span><span class="op">[</span><span class="st">"test_description.character"</span><span class="op">]</span></span></code></pre></div>
<p>Viewing results as a <code>data.frame</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/pkg_srcrefs_df.html">pkg_srcrefs_df</a></span><span class="op">(</span><span class="va">examplepkg_ns</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   name                          srcref  namespace</span></span>
<span><span class="co">#&gt; 1      nested_function  complex_call_stack.R:9:20:11:1 examplepkg</span></span>
<span><span class="co">#&gt; 2                adder           r6_example.R:3:10:9:1 examplepkg</span></span>
<span><span class="co">#&gt; 3   recursive_function complex_call_stack.R:21:23:24:1 examplepkg</span></span>
<span><span class="co">#&gt; 4          Accumulator         r6_example.R:29:16:32:3 examplepkg</span></span>
<span><span class="co">#&gt; 6 s3_example_func.list         s3_example.R:20:25:22:1 examplepkg</span></span>
<span><span class="co">#&gt; 7      s3_example_func         s3_example.R:10:20:12:1 examplepkg</span></span></code></pre></div>
<p>Extracing individual <code>srcref</code>s from the resulting
<code>data.frame</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg_srcrefs_df.html">pkg_srcrefs_df</a></span><span class="op">(</span><span class="va">examplepkg_ns</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">srcref</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; function(x) {</span></span>
<span><span class="co">#&gt;   deeper_nested_function(x)</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="extracting-test-srcrefs">Extracting test <code>srcref</code>s<a class="anchor" aria-label="anchor" href="#extracting-test-srcrefs"></a>
</h4>
<p>Similarly, we can extract test <code>srcrefs</code> using equivalent
functions for tests. However, to get test traces, we must first run the
package coverage, which records exactly which tests were actually run by
the test suite. Starting from coverage omits any skipped tests or
unevaluated test lines, only presenting test code that is actually
run.</p>
<p>Note that the original source files will no longer exist, as
<code>covr</code> will install the package into a temporary location for
testing. Because of this, test “srcrefs” are actually <code>call</code>
objects with a <code>with_pseudo_srcref</code>, allowing them to be
treated like a <code>srcref</code>s for consistency.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">examplepkg_test_srcrefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/test_srcrefs.html">test_srcrefs</a></span><span class="op">(</span><span class="va">examplepkg_cov</span><span class="op">)</span></span></code></pre></div>
<p>Despite not having a valid <code>srcfile</code>, we can still use all
of our favorite <code>srcref</code> functions because of the
<code>with_pseudo_scref</code> subclass:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sourceutils.html" class="external-link">getSrcFilename</a></span><span class="op">(</span><span class="va">examplepkg_test_srcrefs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; character(0)</span></span></code></pre>
<p>And finally, there is a corresponding <code>*_df</code> function to
make this information easier to see at a glance:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">examplepkg_test_srcrefs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; show(&lt;myS4Example&gt;)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`/tmp/RtmprtnTW4/R_LIBS257458b3b011/examplepkg/examplepkg-tests/testthat/test-complex-calls.R:2:3:2:50:3:50:2:2`</span></span>
<span><span class="co">#&gt; complex_call_stack("test")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`/tmp/RtmprtnTW4/R_LIBS257458b3b011/examplepkg/examplepkg-tests/testthat/test-complex-calls.R:6:3:6:54:3:54:6:6`</span></span>
<span><span class="co">#&gt; deeper_nested_function("test")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`/tmp/RtmprtnTW4/R_LIBS257458b3b011/examplepkg/examplepkg-tests/testthat/test-complex-calls.R:15:7:15:54:7:54:15:15`</span></span>
<span><span class="co">#&gt; complex_call_stack("test")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`/tmp/RtmprtnTW4/R_LIBS257458b3b011/examplepkg/examplepkg-tests/testthat/test-complex-calls.R:15:7:15:54:7:54:15:15`</span></span>
<span><span class="co">#&gt; complex_call_stack("test")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`/tmp/RtmprtnTW4/R_LIBS257458b3b011/examplepkg/examplepkg-tests/testthat/test-complex-calls.R:15:7:15:54:7:54:15:15`</span></span>
<span><span class="co">#&gt; complex_call_stack("test")</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="extracting-trace-srcrefs">Extracting trace <code>srcref</code>s<a class="anchor" aria-label="anchor" href="#extracting-trace-srcrefs"></a>
</h4>
<p>The final piece of the puzzle is the coverage traces. These are the
simplest to find, since <code>covr</code> stores this information with
every coverage object. Even without any helper functions, you can find
this information by indexing into a coverage object to explore for
yourself.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">examplepkg_cov</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">srcref</span></span>
<span><span class="co">#&gt; private$age &lt;- age</span></span></code></pre></div>
<p>Nevertheless, we provide simple alternatives for restructuring this
data into something more consistent with the rest of the pacakge.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">examplepkg_trace_srcrefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trace_srcrefs.html">trace_srcrefs</a></span><span class="op">(</span><span class="va">examplepkg_cov</span><span class="op">)</span></span>
<span><span class="va">examplepkg_trace_srcrefs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt; $`r6_example.R:63:7:63:24:7:24:100:100`</span></span>
<span><span class="co">#&gt;  63</span></span>
<span><span class="co">#&gt;   7</span></span>
<span><span class="co">#&gt;  63</span></span>
<span><span class="co">#&gt;  24</span></span>
<span><span class="co">#&gt;   7</span></span>
<span><span class="co">#&gt;  24</span></span>
<span><span class="co">#&gt; 100</span></span>
<span><span class="co">#&gt; 100</span></span></code></pre></div>
<p>And just like the other functions in the family, this too comes with
a <code>*_df</code> companion function.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/trace_srcrefs_df.html">trace_srcrefs_df</a></span><span class="op">(</span><span class="va">examplepkg_cov</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                   name                  srcref</span></span>
<span><span class="co">#&gt; 1 r6_example.R:63:7:63:24:7:24:100:100 r6_example.R:63:7:63:24</span></span>
<span><span class="co">#&gt; 2 r6_example.R:74:7:74:23:7:23:111:111 r6_example.R:74:7:74:23</span></span>
<span><span class="co">#&gt; 3       r6_example.R:4:3:8:3:3:3:41:45    r6_example.R:4:3:8:3</span></span>
<span><span class="co">#&gt; 4 r6_example.R:97:9:97:22:9:22:134:134 r6_example.R:97:9:97:22</span></span>
<span><span class="co">#&gt; 5 s3_example.R:16:3:16:11:3:11:259:259 s3_example.R:16:3:16:11</span></span>
<span><span class="co">#&gt; 6     hypotenuse.R:8:3:8:25:3:25:35:35   hypotenuse.R:8:3:8:25</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>With all of this information, we can match related code blocks to one
another to retrospectively evaluate the relationship between package
code and tests.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Doug Kelkhoff, Szymon Maksymiuk, Andrew McNeil, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
