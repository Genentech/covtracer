<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with srcrefs • covtracer</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Working with srcrefs">
<meta property="og:description" content="covtracer">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">covtracer</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/combining_srcref_data.html">Combining srcref Data</a>
    </li>
    <li>
      <a href="../articles/working_with_srcrefs.html">Working with srcrefs</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../">
    <span class="fa fa-gitlab fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../coverage.html">
    <span class="fa fa-layer-group"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="working_with_srcrefs_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Working with srcrefs</h1>
            
      
      
      <div class="hidden name"><code>working_with_srcrefs.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">covtracer</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">examplepkg_ns</span><span class="op">$</span><span class="va">hypotenuse</span><span class="op">)</span>
<span class="co">#&gt; function(a, b) {</span>
<span class="co">#&gt;   return(sqrt(a^2 + b^2))</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;bytecode: 0x55bb0dcac460&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:examplepkg&gt;</span></code></pre></div>
<div id="what-are-srcref-objects" class="section level1">
<h1 class="hasAnchor">
<a href="#what-are-srcref-objects" class="anchor"></a>What are <code>srcref</code> objects?</h1>
<p><code>srcref</code>s are a base R data type that is used frequently for working with package code. When you install a package using the <code>--with-keep.source</code> flag, data about the package’s source code representation is bound to the objects that the namespace attaches or loads. In short, <code>srcref</code>s are simple data structures which store the file path of the source code and information about where to find the relevant bits in that file including line and character columns of the start and end of the source code.</p>
<blockquote>
<p>For extensive details, refer to <code><a href="https://rdrr.io/r/utils/sourceutils.html">?getSrcref</a></code> and <code><a href="https://rdrr.io/r/base/srcfile.html">?srcref</a></code>.</p>
</blockquote>
<p>Lets see it in action:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sourceutils.html">getSrcref</a></span><span class="op">(</span><span class="fu">covtracer</span><span class="fu">::</span><span class="va"><a href="../reference/test_trace_df.html">test_trace_df</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get line and column ranges (for details see ?srcref)</span>
<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/sourceutils.html">getSrcref</a></span><span class="op">(</span><span class="fu">covtracer</span><span class="fu">::</span><span class="va"><a href="../reference/test_trace_df.html">test_trace_df</a></span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; numeric(0)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sourceutils.html">getSrcFilename</a></span><span class="op">(</span><span class="fu">covtracer</span><span class="fu">::</span><span class="va"><a href="../reference/test_trace_df.html">test_trace_df</a></span><span class="op">)</span>
<span class="co">#&gt; character(0)</span></code></pre></div>
</div>
<div id="extracting-relevant-traceability-srcrefs" class="section level1">
<h1 class="hasAnchor">
<a href="#extracting-relevant-traceability-srcrefs" class="anchor"></a>Extracting relevant traceability <code>srcref</code>s</h1>
<p>Instead of working with these objects directly, there are a few helper functions for making these objects easier to extract. For tracing coverage paths, there are three important classes of <code>srcref</code>s:</p>
<ol style="list-style-type: decimal">
<li>Package namespace object <code>srcref</code>s</li>
<li>Test code <code>srcref</code>s</li>
<li>Coverage trace <code>srcref</code>s</li>
</ol>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>Before we begin, we’ll get a package test coverage object and store the package namespace. We take extra precaution to use a temporary library for the sake of example, but this is only necessary when we want to avoid installing the package into our working library.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://withr.r-lib.org">withr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://covr.r-lib.org">covr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org">remotes</a></span><span class="op">)</span>

<span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_temp_libpaths.html">with_temp_libpaths</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>keep.source <span class="op">=</span> <span class="cn">TRUE</span>, keep.source.pkg <span class="op">=</span> <span class="cn">TRUE</span>, covr.record_tests <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">examplepkg_source_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"examplepkg"</span>, package <span class="op">=</span> <span class="st">"covtracer"</span><span class="op">)</span>
  <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_local.html">install_local</a></span><span class="op">(</span>
    <span class="va">examplepkg_source_path</span>, 
    quiet <span class="op">=</span> <span class="cn">TRUE</span>,
    INSTALL_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"--with-keep.source"</span>, <span class="st">"--install-tests"</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="va">examplepkg_cov</span> <span class="op">&lt;-</span> <span class="fu">covr</span><span class="fu">::</span><span class="fu"><a href="http://covr.r-lib.org/reference/package_coverage.html">package_coverage</a></span><span class="op">(</span><span class="va">examplepkg_source_path</span><span class="op">)</span>
  <span class="va">examplepkg_ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-reflect.html">getNamespace</a></span><span class="op">(</span><span class="st">"examplepkg"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div id="functions-for-extracting-srcrefs" class="section level2">
<h2 class="hasAnchor">
<a href="#functions-for-extracting-srcrefs" class="anchor"></a>Functions for extracting <code>srcref</code>s</h2>
<p>There are a few functions for teasing out this information succinctly. These include <code>pkg</code>, <code>trace</code>, and <code>test</code> flavors for <code>*_srcefs</code> and <code>*_srcrefs_df</code> families of functions (eg, <code><a href="../reference/pkg_srcrefs_df.html">pkg_srcrefs_df()</a></code>). <code>*_srcrefs()</code> functions return a more primitive <code>list</code> objects. Because these can be a bit cumbersome to read through, <code>*_srcrefs_df()</code> alternatives are provided for improved introspection and readability.</p>
<blockquote>
<p><code>data.frame</code> results contain a <code>srcref</code> column, where each element is a <code>srcref</code> object. Even though this appears as a succinct text, it contains all the <code>srcref</code> data.</p>
</blockquote>
<div id="extracting-package-namespace-object-srcrefs" class="section level3">
<h3 class="hasAnchor">
<a href="#extracting-package-namespace-object-srcrefs" class="anchor"></a>Extracting package namespace object <code>srcref</code>s</h3>
<p>Getting a <code>list</code> of <code>srcref</code>s</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/pkg_srcrefs.html">pkg_srcrefs</a></span><span class="op">(</span><span class="va">examplepkg_ns</span><span class="op">)</span><span class="op">[</span><span class="st">"test_description.character"</span><span class="op">]</span></code></pre></div>
<p>Viewing results as a <code>data.frame</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/pkg_srcrefs_df.html">pkg_srcrefs_df</a></span><span class="op">(</span><span class="va">examplepkg_ns</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;                      name                  srcref</span>
<span class="co">#&gt; 1 s3_example_func.default s3_example.R:14:28:16:1</span>
<span class="co">#&gt; 2                   Rando r6_example.R:87:12:94:3</span>
<span class="co">#&gt; 3                  Person r6_example.R:52:18:56:5</span>
<span class="co">#&gt; 4                  Person r6_example.R:64:13:69:5</span>
<span class="co">#&gt; 5  names,S4Example-method s4_example.R:15:44:17:1</span>
<span class="co">#&gt; 6 names,S4Example2-method s4_example.R:32:45:34:1</span></code></pre></div>
<p>Extracing individual <code>srcref</code>s from the resulting <code>data.frame</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg_srcrefs_df.html">pkg_srcrefs_df</a></span><span class="op">(</span><span class="va">examplepkg_ns</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">srcref</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; function(x, ...) {</span>
<span class="co">#&gt;   "default"  </span>
<span class="co">#&gt; }</span></code></pre></div>
</div>
<div id="extracting-test-srcrefs" class="section level3">
<h3 class="hasAnchor">
<a href="#extracting-test-srcrefs" class="anchor"></a>Extracting test <code>srcref</code>s</h3>
<p>Similarly, we can extract test <code>srcrefs</code> using equivalent functions for tests. However, to get test traces, we must first run the package coverage, which records exactly which tests were actually run by the test suite. Starting from coverage omits any skipped tests or unevaluated test lines, only presenting test code that is actually run.</p>
<p>Note that the original source files will no longer exist, as <code>covr</code> will install the package into a temporary location for testing. Because of this, test “srcrefs” are actually <code>call</code> objects with a <code>with_pseudo_srcref</code>, allowing them to be treated like a <code>srcref</code>s for consistency.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_srcrefs.html">test_srcrefs</a></span><span class="op">(</span><span class="va">examplepkg_cov</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="co">#&gt; $`/tmp/Rtmp9EQPsU/R_LIBS38cf552217cd/examplepkg/examplepkg-tests/testthat/test-hypotenuse.R:2:3:2:35:3:35:2:2`</span>
<span class="co">#&gt; hypotenuse(3, 4)</span></code></pre></div>
<p>Despite not having a valid <code>srcfile</code>, we can still use all of our favorite <code>srcref</code> functions because of the <code>with_pseudo_scref</code> subclass:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sourceutils.html">getSrcFilename</a></span><span class="op">(</span><span class="fu"><a href="../reference/test_srcrefs.html">test_srcrefs</a></span><span class="op">(</span><span class="va">examplepkg_cov</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; [1] "test-hypotenuse.R"</span></code></pre></div>
<p>And finally, there is a corresponding <code>*_df</code> function to make this information easier to see at a glance:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/test_srcrefs_df.html">test_srcrefs_df</a></span><span class="op">(</span><span class="va">examplepkg_cov</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;                                                        name                       srcref</span>
<span class="co">#&gt; 1                        hypotenuse is calculated correctly   test-hypotenuse.R:2:3:2:35</span>
<span class="co">#&gt; 2 hypotenuse is calculated correctly; with negative lengths   test-hypotenuse.R:5:5:5:39</span>
<span class="co">#&gt; 3        Example R6 Accumulator class constructor is traced   test-r6-example.R:2:3:2:43</span>
<span class="co">#&gt; 4           Example R6 Accumulator class methods are traced   test-r6-example.R:7:3:7:43</span>
<span class="co">#&gt; 5           Example R6 Accumulator class methods are traced   test-r6-example.R:8:3:8:36</span>
<span class="co">#&gt; 6         Example R6 Person class public methods are traced test-r6-example.R:12:3:12:40</span></code></pre></div>
</div>
<div id="extracting-trace-srcrefs" class="section level3">
<h3 class="hasAnchor">
<a href="#extracting-trace-srcrefs" class="anchor"></a>Extracting trace <code>srcref</code>s</h3>
<p>The final piece of the puzzle is the coverage traces. These are the simplest to find, since <code>covr</code> stores this information with every coverage object. Even without any helper functions, you can find this information by indexing into a coverage object to explore for yourself.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">examplepkg_cov</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">srcref</span>
<span class="co">#&gt; "list"</span></code></pre></div>
<p>Nevertheless, we provide simple alternatives for restructuring this data into something more consistent with the rest of the pacakge.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/trace_srcrefs.html">trace_srcrefs</a></span><span class="op">(</span><span class="va">examplepkg_cov</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="co">#&gt; $`s3_example.R:20:3:20:8:3:8:207:207`</span>
<span class="co">#&gt;  20</span>
<span class="co">#&gt;   3</span>
<span class="co">#&gt;  20</span>
<span class="co">#&gt;   8</span>
<span class="co">#&gt;   3</span>
<span class="co">#&gt;   8</span>
<span class="co">#&gt; 207</span>
<span class="co">#&gt; 207</span></code></pre></div>
<p>And just like the other functions in the family, this too comes with a <code>*_df</code> companion function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/trace_srcrefs_df.html">trace_srcrefs_df</a></span><span class="op">(</span><span class="va">examplepkg_cov</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;                                   name                  srcref</span>
<span class="co">#&gt; 1   s3_example.R:20:3:20:8:3:8:207:207  s3_example.R:20:3:20:8</span>
<span class="co">#&gt; 2   r6_example.R:89:9:89:22:9:22:89:89 r6_example.R:89:9:89:22</span>
<span class="co">#&gt; 3   rd_sampler.R:57:3:57:6:3:6:185:185  rd_sampler.R:57:3:57:6</span>
<span class="co">#&gt; 4 s4_example.R:33:3:33:15:3:15:242:242 s4_example.R:33:3:33:15</span>
<span class="co">#&gt; 5 r6_example.R:90:7:90:14:7:14:102:102 r6_example.R:90:7:90:14</span>
<span class="co">#&gt; 6   r6_example.R:54:7:54:26:7:26:66:66 r6_example.R:54:7:54:26</span></code></pre></div>
</div>
</div>
</div>
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<p>With all of this information, we can match related code blocks to one another to retrospectively evaluate the relationship between package code and tests.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Doug Kelkhoff, Andrew McNeil.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
